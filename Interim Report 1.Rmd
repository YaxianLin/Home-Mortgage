---
title: "Interim Report 1"
author: "Yaxian Lin, Chenlu Jiang, Jingwen Wu"
date: "2018/2/21"
output: word_document
---

The URL for our Team GitHub repository is {https://github.com/YaxianLin/Home-Mortgage.git}. 
The URL to the Kaggle dataset is {https://www.kaggle.com/jboysen/ny-home-mortgage/data}.
The URL to the kernel is {https://www.kaggle.com/ambarish/eda-home-mortgage-ny-with-feature-analysis/notebook}


# Problem Identification
The dataset we have contains all mortgage decisions made in 2015 for the state of New York. The data problems for the dataset are that there are too many potential determined variables for loan origination, some of them have numerous missing data and some of them are repetitive. For our final managerial objective: helping banks to find out what essential variables determine the loan origination, we need to clean, tidy and deal with the data to figure out a reasonable model to solve the problem.


# Data Inspection
```{r, eval=FALSE}
library(ggplot2)
library(dplyr)
Mortgage <-read.csv("~/Downloads/ny_hmda_2015.csv")
ls(Mortgage)
unique(Mortgage$applicant_sex_name)
unique(Mortgage$applicant_sex)
unique(Mortgage$owner_occupancy_name)
unique(Mortgage$action_taken_name)
```
As you can see, there are 78 variables in the dataset. It is redundant to describe the mearsurement types of all 78 variables. Besides, some of them illustrate the same thing, such as "action_taken" and "action_taken_name". Hence, we will only describe several important variables as examples.  
In general, we divide the 78 variables into 5 subjects as kernel. 
* applicant: ethnicity, race, sex,income level and so on
* lender: agency
* property: property type, occupancy of the property, and so on
* mortage information: action, amount, lien status, type and purpose
* location: state, census tract 

In general, most variables in the data are nominal variables. For example, "action_taken" indicates the 7 different result of loan application. All variables relevant to applicant except "applicant_income_000s", such as race or gender, are nominal variables. "applicant_income_000s" is a ratio scale variabe, showing the incomel level of the applicant. "loan_amount_000s" is also ratio scale variables while "as_of_year" is a rare interval variable in this dataset.

# Table summarizing range in each variable
```{r}
library(pastecs)
RangeVar <- c("applicant_income_000s","hud_median_family_income", "loan_amount_000s", "number_of_1_to_4_family_units", "number_of_owner_occupied_units", "minority_population", "population", "rate_spread", "tract_to_msamd_income")
stat.desc(Mortgage[, RangeVar])[c("min", "max", "range", "median", "mean"),]
```

As mentioned above, there are 78 variables in this dataset. It does not make sense to compute range and other descriptive statistics for all of them since some of them are categorical data (action_taken, agency_code, applicant_race etc.) and some of them are string variables (applicant_sex_name,  applicant_ethnicity_name etc.) Statistics like range, min, max, mean do not have actual meaning for these variables. Therefore, subset RangeVar is created to only include variables whose descriptive statistics are meaningful in the Mortgage dataset. The subset RangeVar include 9 variables: applicant_income_000s, hud_median_family_income, loan_amount_000s, number_of_1_to_4_family_units, number_of_owner_occupied_units, minority_population, population, rate_spread, tract_to_msamd_income. Then the stat.desc function from the pastecs package is used to compute range and other descriptive statistics of variables in subset NumVar. Also, the stat.desc function computes 14 kinds of statistics and most of them are not necessary in this case. Thus, only min, max, range, median, and mean are included in the table.

# Missing Data
Before dealing with missing data, we first create a new dataset called Mortage1 with unique and meaningful variables. To be specific, for those variables indicating the same meaning, only numeric variables are chosen. For example, we chose "action_taken" and dropped "action_taken_name". Also, for variables with more than 50% missing data, such as rate_spread, applicant-race_2/3/4/5, denial_reason_1/2/3 etc., we decide to straightly delete them.
Among the 30 variables, 9 variables contain missing values. 
For nominal variables like "census_tract_number", we decided to use the mode category to replace the missing value.

```{r, results= 'hide'}
summary(Mortgage)
Mortgage1 <- Mortgage[,c(1,2,3,6,8,9,19,21,23,24,26,36,38,48,50,52,54,56,58,60,62,64,66,67,68,72,73,74,75,76,78)]
summary(Mortgage1)
Mortgage1$applicant_income_000s[is.na(Mortgage1$applicant_income_000s)] = mean(Mortgage1$applicant_income_000s, na.rm = TRUE)
Mode = function(x){
   ux = sort(unique(x))
   tabx = table(x)
   maxf = ux[which(tabx ==
max(tabx))]
   return(maxf)
}
Mortgage1$msamd[is.na(Mortgage1$msamd)] = Mode(Mortgage1$msamd)
Mortgage1$county_code[is.na(Mortgage1$county_code)] = Mode(Mortgage1$county_code)
Mortgage1$census_tract_number[is.na(Mortgage1$census_tract_number)] = Mode(Mortgage1$census_tract_number)
Mortgage1$number_of_1_to_4_family_units[is.na(Mortgage1$number_of_1_to_4_family_units)] = mean(Mortgage1$number_of_1_to_4_family_units, na.rm = TRUE)
Mortgage1$number_of_owner_occupied_units[is.na(Mortgage1$number_of_owner_occupied_units)] = mean(Mortgage1$number_of_owner_occupied_units, na.rm = TRUE)
Mortgage1$minority_population[is.na(Mortgage1$minority_population)] = mean(Mortgage1$minority_population, na.rm = TRUE)
Mortgage1$population[is.na(Mortgage1$population)] = mean(Mortgage1$population, na.rm = TRUE)
Mortgage1$tract_to_msamd_income[is.na(Mortgage1$tract_to_msamd_income)] = mean(Mortgage1$tract_to_msamd_income, na.rm = TRUE)

```

## Define Variable Loan_Approval
```{r}
Mortgage1$Loan_Approval = "NotApproved"
Mortgage1$Loan_Approval[Mortgage1$action_taken == 1] = "Approved"
Mortgage1$Loan_Approval[Mortgage1$action_taken == 2] = "Approved"
Mortgage1$Loan_Approval[Mortgage1$action_taken == 6] = "Approved"
```
Under the variable action_taken, number 1-7 indicates:
1 - loan originated
2 - loan approved but not accepted
3 - application denied by financial institutions
4 - application withdrawn by applicant
5 - file closed for incompleteness
6 - loan purchased by the institution
7 - pre-approval request denied by financial institutions
Therefore, we created variable Loan_Approval for all observation. For observations with action_taken of 1, 2, and 6, their Loan_Approval indicate "Approved." For the remaining observations, their Loan_Approval are "NotApproved."

## Compare the mean loan amounts between loans that were and were not approved
```{r}
t.test(Mortgage1$loan_amount_000s~Mortgage1$Loan_Approval)
```
Welch Two Sample t-test is used to compare the mean loan amounts between loans that were and were not approved. R command t.test(y~x) is used where y is the numeric variable (loan_amount_000s) and x is a binary variable (Loan_Approval, either "Approved" or "NotApproved").

The null hypothesis for this t-test is that, the mean loan amounts between loans that were and were not approved are the same. The alternate hypothesis suggests the opposite. The t-test results show a t-value of 3.8170 and a p-value of 0.0001346. The null hypothesis is rejected and the alternate hypothesis is true. The difference in means is not equal to 0. 

In a word, the t-test suggests that, the mean loan amounts between loans that were and were not approved are not the same, in a 99% confidence level.

## Difference in loan approval rates between high and low-income households
```{r}
Mortgage1$Income_Level = "low"
Mortgage1$Income_Level[Mortgage1$applicant_income_000s > 60.741] = "high"
install.packages("gmodels")
library(gmodels)
CrossTable(Mortgage1$Income_Level, Mortgage1$Loan_Approval)
t.test(Mortgage1$applicant_income_000s~Mortgage1$Loan_Approval)
```
Variable Income_Level is created to divided the loan applicants into two categories: high income and low income. According to the statistic on U.S Census website, the median income in the New York state is $60,741. Therefore, loan applicants with income higher than $60,741 are considered having a high income. Applicants with income equal or lower than $60,741 are considered having a low income. 

CrossTable command is then used to compare the loan approval rates between high and low-income households. The results show that, 71.2% of high-income loan applicants had their loan applications approved and 62.3% of low-income applicants had their loan applications approved. 

Welch Two Sample t-test is again used to test the independence of loan approval rate and household income. R command t.test(y~x) is used where y is the numeric variable (applicant_income_000s) and x is a binary variable (Loan_Approval, either "Approved" or "NotApproved"). The null hypothesis for this t-test is that, the mean applicant income between loans that were and were not approved are the same. The alternate hypothesis suggests the opposite. The t-test results show a t-value of 1.8046 and a p-value of 0.07114. The null hypothesis is rejected and the alternate hypothesis is true. The difference in means is not equal to 0. The t-test suggests that, the mean applicant incomes between loans that were and were not approved are not the same with a 90% confidence level. 

# Histograms and density plots for key variables

Histogram and density plots are computed for four key variables: action_taken, loan_amount, gender and applicant_ethnicity. 

## Density histogram of action taken on loan
```{r}
library(ggplot2)
library(dplyr)
action= Mortgage1 %>% group_by(action_taken_name) %>%
  summarise(count = n()) %>%
  mutate(p = count/sum(count) * 100)

ggplot(action, aes(x =action_taken_name, y = p)) +
  geom_bar(stat='identity',colour="white")+
  labs(x='action_taken', y='percentage',title='mortgage action') +
  coord_flip()
```
Like the Kernel, the first thing we did was to inspect the key variable action_taken_name. According to the result, more than half of loans are originated. We need to find which factors make the difference.

## Histogram plot for gender
```{r}
Mortgage1$gender = "0"
Mortgage1$gender[Mortgage1$applicant_sex == 1] = "Male"
Mortgage1$gender[Mortgage1$applicant_sex == 2] = "Female"
Mortgage1$gender[Mortgage1$applicant_sex == 3] = "Noinfo"
Mortgage1$gender[Mortgage1$applicant_sex == 4] = "Noapp"
his_gender <- Mortgage1 %>%
  ggplot(aes(x=gender)) +
  geom_bar() +
  ggtitle("Histogram plot for gender") +
  labs(x = "gender")
his_gender
```
The histogram plot for gender shows than the number of male loan applicants are twice of the number of female loan applicants.

## Histogram for Ethnicity
```{r}
Mortgage1$applicant_ethnicity_name[Mortgage$applicant_ethnicity == 1] = "Hispanic or Latino"
Mortgage1$applicant_ethnicity_name[Mortgage$applicant_ethnicity == 2] = "Not Hispanic or Latino"
Mortgage1$applicant_ethnicity_name[Mortgage$applicant_ethnicity == 3] = "Info Not Available"
Mortgage1$applicant_ethnicity_name[Mortgage$applicant_ethnicity == 4] = "Not Applicable"
ethnicity = Mortgage1 %>% group_by(applicant_ethnicity_name) %>%
  summarise(count = n()) %>%
  mutate(p = count/sum(count) * 100)
ggplot(ethnicity, aes(x = applicant_ethnicity_name, y = p)) +
  geom_bar(stat='identity',colour="white")+
  labs(x='applicant ethnicity', y='pencentage',title='Ethnicity of Mortgage Applicants')
```
The histogram plot for ethnicity of the New York mortgage applicants in 2015 indicates that about 5% of the observations are Hispanic or Latino; 10% of the observations have no available ethnicity information in this dataset; 13% of the observations have their ethnicity information listed as “not applicable”; 72% of the observations are not Hispanic or Latino. 
The histogram plot for gender of the New York mortgage applicants in 2015 shows that, out of 439,654 total observations, 119,877 (27.27%) of them are female; 242,175 (55.08%) of them are male; 27,163 (6.18%) of the observations did not provide gender information; 50,439 (11.47%) of the observations have their gender listed as “not applicable.” 




## Density plot for income
Need to be improved
```{r}
Mortgage1 %>%
  ggplot(aes(x = applicant_income_000s)) +
  geom_density(color = "black") +
  scale_x_continuous(limits = c(0,800)) +
  ggtitle("Density plot for income") +
  xlab("income")

```
The left skewed density plot shows that most of the applicants' income concentrate on around $50. And there are much less applicants with high income.

# Bivariate frequency distribution

In order to have a clearer data pattern, we first created a new variable called “lo”, dividing action taken data into originated loan and unoriginated regardless of the denial reasons. We then combined the new variable with applicant income level, loan amount, and applicant ethnicity to see whether any pattern exists.

## Income distribution via loan origination
```{r}
Mortgage1$lo <- 'unoriginated'
Mortgage1$lo[Mortgage1$action_taken_name == 'Loan originated'] <- 'originated'
Mortgage1 %>%
  ggplot(aes(applicant_income_000s, fill = lo))  +
  geom_histogram(binwidth = 15, alpha = 0.8, color = "darkblue") +
  labs(x = 'Income', y = 'Count', title = 'Income distribution via loan origination ') +
  scale_x_continuous(limits = c(0, 800) ) 
```

From the income distribution via loan origination plot, it is clear that the percentage of the loan originated increase first and then decrease along to the increasing income. Therefore, we can make a conclusion that applicants, with the income level at about $50,000 to $100,000,  are more likely to receive the loan. 



## Loan amount distribution via loan origination
```{r}
Mortgage1 %>%
  ggplot(aes(loan_amount_000s, fill = lo))  +
  geom_histogram(binwidth = 18, color = "darkblue") +
  labs(x = 'loan amount', y = 'Count', title = 'Loan amount distribution via originated and unoriginated ') +
  scale_x_continuous(limits = c(0, 1000) )
```

The distribution of loan amount among loan originated and unoriginated are all left-skewed and it is hard to find a pattern between them. 


## Applicant ethnicity via loan origination
```{r}
library(gmodels)
CrossTable(Mortgage1$applicant_ethnicity_name, Mortgage1$lo)
```

The crosstable of applicant ethnicity and loan origination indicates that people who are not  Hispanic or Latino are more likely to have the loan originated. While 82.9% of the observations who had their mortgage applications approved are not Hispanic or Latino, 62.1% of the observations who had their mortgage applications denied are not Hispanic or Latino. Also, while 51.9% of the total applicants (regardless of ethnicity) had their loans approved, 59% of non-Hispanic or Latino applicants had their loan approved. 

# discussion of data patern

Through making plots and analysis above, we have seen some patterns within variables and between variables. For example, people with the income level between $50,000 to $100,000 are more likely to get loans. However, besides the applicant characters, we also believe some other variables are essential to determining the loan origination. We believe that location variables such as "State"; property type; loan related variables such as purpose of the loan and type of the loan; and lenders' character are all relevant to loan origination. We will consider to add some of these variables into our model.

